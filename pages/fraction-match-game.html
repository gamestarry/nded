<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NDED - Building mathematical confidence for life">
    <meta name="keywords" content="mathematics, math games, matrix calculator, math education">
    <meta name="author" content="NDED">
    <title>NDED - Fraction, Decimal & Percent Memory Game</title>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for NDED styling -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@800;900&family=Raleway:wght@400;500&display=swap" rel="stylesheet">
    <link rel="canonical" href="https://www.nd-ed.org/pages/fraction-math-game.html">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #8a2be2;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: var(--dark-color);
            line-height: 1.6;
            /* 防止拖拽时页面滚动 */
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 主行布局容器 */
        .main-row-container {
            width: 100%;
            background-color: #f9f9f9;
            padding: 0 0 2rem 0;
            position: relative;
            z-index: 1;
        }
        
        /* 更宽的容器，用于容纳三个并排的部分 */
        .wide-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 主行布局 */
        .main-row {
            display: flex;
            gap: 2rem;
        }
        
        .left-sidebar, .right-sidebar {
            flex: 0 0 250px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .main-content {
            flex: 1;
            position: relative;
            z-index: 1;
            min-width: 0; /* 防止内容溢出 */
        }

        /* 动态内容容器样式 - 游戏容器将放在这里 */
        .dynamic-content-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow: hidden; /* 防止内容溢出 */
        }

        .dynamic-content-container h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: none;
            padding-bottom: 0;
        }

        .dynamic-content-container p {
            color: var(--dark-color);
            text-align: center;
            max-width: 600px;
            margin-bottom: 1.5rem;
        }

        /* 左侧导航栏样式 */
        .nav-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-color);
            text-align: center;
        }

        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .nav-button {
            background-color: var(--light-color);
            color: var(--primary-color);
            border: 2px solid var(--secondary-color);
            padding: 0.45rem 1rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: block;
            font-weight: 500;
        }

        .nav-button:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-color: var(--secondary-color);
        }

        .nav-button:active {
            transform: translateY(0);
        }

        /* 为外部链接按钮添加外链标志 */
        .nav-button.external {
            position: relative;
            padding-right: 2.5rem;
            background-color: var(--light-color);
            color: var(--primary-color);
            border: 2px solid var(--secondary-color);
        }

        .nav-button.external::after {
            content: "↗";
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .nav-button.external:hover {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .nav-button.external:hover::after {
            transform: translateY(-50%) translateX(2px) translateY(-2px);
        }

        /* 头部样式 - 已修改，整体缩小10% */
        header {
            background: linear-gradient(135deg, #00447F 0%, #0066AA 100%);
            color: white;
            padding: 0.2rem 0; /* 从0.25rem减小到0.2rem */
            text-align: center;
            margin-bottom: 0.45rem; /* 从0.5rem减小到0.45rem */
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: visible;
            display: flex;
            align-items: center;
            min-height: 81px; /* 从90px减小到81px，缩小10% */
            z-index: 1000;
            transform: scaleY(0.9); /* 垂直方向整体缩小10% */
            transform-origin: top; /* 从顶部开始缩放 */
        }

        /* 添加微妙的纹理效果 */
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }

        /* 新的标题样式 - 缩小10% */
        .main-title {
            font-size: 2.52rem; /* 从2.8rem减小到2.52rem，缩小10% */
            margin-bottom: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            line-height: 1.2;
            font-family: 'Raleway', sans-serif;
            font-weight: 500;
            display: flex;
            align-items: flex-end;
            flex-wrap: wrap;
            justify-content: center;
            transform: scale(0.9); /* 内部元素再缩小10%以保持整体比例 */
            transform-origin: center;
        }
        
        /* NDED特殊样式 - 修改为向内凹的圆角，缩小10% */
        .nded-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 900;
            font-size: 2.88rem; /* 从3.2rem减小到2.88rem，缩小10% */
            color: #2c3e50;
            letter-spacing: 0.45px; /* 从0.5px减小到0.45px */
            display: inline-block;
            position: relative;
            padding: 0 10.8px; /* 从12px减小到10.8px，缩小10% */
            margin-right: 7.2px; /* 从8px减小到7.2px，缩小10% */
            background-color: rgba(255, 255, 255, 0.9);
            
            /* 修改为向内凹的圆角效果 */
            border-radius: 10.8px; /* 从12px减小到10.8px，缩小10% */
            box-shadow: 
                inset 2.7px 2.7px 4.5px rgba(0, 0, 0, 0.2), /* 缩小10% */
                inset -2.7px -2.7px 4.5px rgba(255, 255, 255, 0.8), /* 缩小10% */
                0 1.8px 3.6px rgba(0, 0, 0, 0.1); /* 缩小10% */
            
            /* 创建向内凹陷的效果 */
            border: 0.9px solid rgba(0, 0, 0, 0.1); /* 从1px减小到0.9px，缩小10% */
            
            /* 确保有明确的高度，便于对齐 */
            line-height: 1.1;
            height: 57.6px; /* 从64px减小到57.6px，缩小10% */
            display: inline-flex;
            align-items: center;
        }
        
        /* 副标题样式 - 添加新的样式，缩小10% */
        .subtitle {
            font-size: 1.71rem; /* 从1.9rem减小到1.71rem，缩小10% */
            font-style: italic;
            color: #f0f0f0;
            text-shadow: 0.9px 0.9px 1.8px rgba(0, 0, 0, 0.3); /* 缩小10% */
            font-weight: 400;
            margin-left: 7.2px; /* 从8px减小到7.2px，缩小10% */
            letter-spacing: 0.45px; /* 从0.5px减小到0.45px，缩小10% */
            
            /* 向下移动，使底边与NDED外框底边对齐 */
            line-height: 1.1;
            display: inline-flex;
            align-items: flex-end;
            height: 57.6px; /* 从64px减小到57.6px，缩小10% */
            
            /* 添加一个微妙的底部边框，帮助视觉对齐 */
            position: relative;
        }
        
        /* 给NDED添加装饰性边框效果 - 更新为适应新设计 */
        .nded-text::before {
            content: "";
            position: absolute;
            top: -2.7px; /* 从-3px减小到-2.7px，缩小10% */
            left: -2.7px; /* 从-3px减小到-2.7px，缩小10% */
            right: -2.7px; /* 从-3px减小到-2.7px，缩小10% */
            bottom: -2.7px; /* 从-3px减小到-2.7px，缩小10% */
            border: 0.9px solid rgba(255, 215, 0, 0.2); /* 从1px减小到0.9px，缩小10% */
            border-radius: 12.6px; /* 从14px减小到12.6px，缩小10% */
            z-index: -1;
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 0.45rem 0; /* 从0.5rem减小到0.45rem，缩小10% */
            margin-top: 2.7rem; /* 从3rem减小到2.7rem，缩小10% */
        }

        /* 右侧边栏样式 */
        .right-sidebar {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            min-height: 200px;
            padding: 1.5rem;
        }

        .right-sidebar-placeholder {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        /* 问答栏样式 */
        .question-box {
            background: white;
            border-radius: 18px; /* 从20px减小到18px，缩小10% */
            box-shadow: 0 9px 22.5px rgba(0,0,0,0.1); /* 缩小10% */
            text-align: center;
            padding: 1.35em; /* 从1.5em减小到1.35em，缩小10% */
            width: 100%;
            transition: all 0.3s ease;
            font-family: "Poppins", "Nunito", sans-serif;
        }

        .question-box h2 {
            font-size: 0.99rem; /* 从1.1rem减小到0.99rem，缩小10% */
            margin-bottom: 1.35em; /* 从1.5em减小到1.35em，缩小10% */
            color: #333;
        }

        .question-box .btn {
            display: block;
            width: 100%;
            padding: 0.72em 0.9em; /* 从0.8em 1em减小到0.72em 0.9em，缩小10% */
            margin-bottom: 0.72em; /* 从0.8em减小到0.72em，缩小10% */
            border-radius: 10.8px; /* 从12px减小到10.8px，缩小10% */
            font-size: 0.855rem; /* 从0.95rem减小到0.855rem，缩小10% */
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .question-box .yes {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
        }

        .question-box .yes:hover {
            transform: scale(1.05);
            box-shadow: 0 3.6px 9px rgba(120,100,255,0.3); /* 缩小10% */
        }

        .question-box .no {
            background: #ffe7e7;
            color: #ff4b4b;
        }

        .question-box .no:hover {
            transform: rotate(-2deg) scale(1.05);
            box-shadow: 0 3.6px 9px rgba(255,75,75,0.2); /* 缩小10% */
        }

        .question-box .response {
            margin-top: 1.35em; /* 从1.5em减小到1.35em，缩小10% */
            font-size: 0.9rem; /* 从1rem减小到0.9rem，缩小10% */
            color: #555;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .question-box .response.show {
            opacity: 1;
        }
        
        /* ====== 游戏CSS整合 ====== */
        /* 我们将游戏CSS放在这里，并做一些调整以适应模板容器 */
        
        /* 游戏粘土风格变量 */
        .memory-game-root {
            /* 基础背景色 */
            --clay-bg: #f0f4f8;
            
            /* 主题颜色 - 匹配分数、小数、百分比三种类型 */
            --fraction-color: #87CEEB;          /* 分数 - 天空蓝 */
            --decimal-color: #FFD93D;           /* 小数 - 黄色 */
            --percent-color: #D1D1FF;           /* 百分比 - 淡蓝色 */
            
            /* 表格边框颜色 - 加深 */
            --table-border: #A0AEC0;
            --table-border-dark: #718096;
            
            /* 通用颜色 */
            --clay-success: #10B981;           /* 成功色 */
            --clay-gray: #94A3B8;              /* 灰色 */
            --clay-dark: #0A1931;              /* 深色背景 */
            --clay-light: #F8FAFC;             /* 浅色背景 */

            /* 3D粘土效果 */
            --clay-shadow: 
                5px 5px 10px rgba(0, 0, 0, 0.07),
                -3px -3px 7px rgba(255, 255, 255, 0.8),
                inset 2px 2px 5px rgba(255, 255, 255, 0.3),
                inset -2px -2px 5px rgba(0, 0, 0, 0.03);

            --clay-shadow-hover: 
                7px 7px 14px rgba(0, 0, 0, 0.09),
                -4px -4px 10px rgba(255, 255, 255, 0.9),
                inset 2px 2px 5px rgba(255, 255, 255, 0.4),
                inset -2px -2px 5px rgba(0, 0, 0, 0.03);

            --clay-shadow-active: 
                3px 3px 6px rgba(0, 0, 0, 0.07),
                -2px -2px 4px rgba(255, 255, 255, 0.8),
                inset 3px 3px 6px rgba(255, 255, 255, 0.2),
                inset -3px -3px 6px rgba(0, 0, 0, 0.04);

            /* 圆角定义 */
            --clay-radius-lg: 22px;
            --clay-radius-md: 12px;
            --clay-radius-sm: 8px;
            --clay-radius-xs: 5px;
            --clay-radius-circle: 50%;

            /* 文本颜色 */
            --text-dark: #2D3748;
            --text-medium: #4A5568;
            --text-light: #718096;
            --text-white: #FFFFFF;
            
            /* 透明度背景 */
            --bg-white-90: rgba(255, 255, 255, 0.9);
            --bg-white-80: rgba(255, 255, 255, 0.8);
            --bg-white-70: rgba(255, 255, 255, 0.7);
            --bg-white-60: rgba(255, 255, 255, 0.6);
            
            /* 边框颜色 */
            --border-white: rgba(255, 255, 255, 0.5);
            
            /* 过渡动画 */
            --transition-fast: 0.1s ease;
            --transition-normal: 0.18s ease;
            --transition-slow: 0.25s ease;
            
            /* 拖拽高亮颜色变量 */
            --drag-highlight-bg: rgba(135, 206, 235, 0.2);
            --drag-highlight-border: rgba(135, 206, 235, 0.8);
        }

        /* 游戏主容器 - 适应模板布局 */
        .memory-game-container {
            width: 100%;
            border-radius: var(--clay-radius-lg);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            backdrop-filter: blur(5px);
            background: linear-gradient(135deg, rgba(135, 206, 235, 0.1), rgba(255, 255, 255, 0.9));
            padding: 1.6rem;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
        }

        /* 游戏标题区域 */
        .memory-game .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-white);
        }

        .memory-game h1 {
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.07);
            padding: 0.7rem;
            border-radius: var(--clay-radius-md);
            background: var(--bg-white-90);
            box-shadow: var(--clay-shadow);
        }

        .memory-game .subtitle {
            color: var(--text-medium);
            font-size: 1.1rem;
            padding: 0.5rem;
            border-radius: var(--clay-radius-sm);
            background: var(--bg-white-80);
            box-shadow: var(--clay-shadow);
            display: inline-block;
            margin-top: 0.5rem;
        }

        /* 游戏信息栏 */
        .memory-game .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0.9rem;
            border-radius: var(--clay-radius-md);
            background: var(--bg-white-90);
            box-shadow: var(--clay-shadow);
            border: 1px solid var(--border-white);
        }

        .memory-game .game-status {
            font-size: 1rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        .memory-game .level-indicator {
            display: inline-block;
            background: linear-gradient(145deg, #87CEEB, #5DB8EB);
            color: var(--text-white);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
        }

        /* 关卡选择器 */
        .memory-game .level-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .memory-game .level-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            background: var(--bg-white-80);
            color: var(--text-medium);
            border: 2px solid var(--border-white);
            border-radius: var(--clay-radius-sm);
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--clay-shadow);
            font-weight: 600;
        }

        .memory-game .level-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--clay-shadow-hover);
        }

        .memory-game .level-btn.active {
            background: linear-gradient(145deg, #87CEEB, #5DB8EB);
            color: var(--text-white);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* 游戏容器 */
        .memory-game .game-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* 左侧：答案栏 */
        .memory-game .answers-section {
            flex: 1;
            border-radius: var(--clay-radius-lg);
            padding: 1.2rem;
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            background: var(--bg-white-90);
            display: flex;
            flex-direction: column;
            min-height: 450px;
        }

        .memory-game .section-title {
            font-size: 1.3rem;
            color: var(--text-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-white);
            font-weight: 700;
        }

        /* 答案容器 */
        .memory-game .answers-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            flex: 1;
            padding: 1rem;
            border-radius: var(--clay-radius-md);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            background: var(--bg-white-80);
            align-content: flex-start;
            overflow: hidden;
        }

        /* 答案卡片 - 保持方形 */
        .memory-game .answer-card {
            color: var(--text-white);
            padding: 10px 15px;
            border-radius: var(--clay-radius-md);
            cursor: grab;
            font-size: 1rem;
            font-weight: 700;
            user-select: none;
            /* transition: all var(--transition-normal);  <-- 这行不要了 */
            transition: none !important; /* 强制关闭所有动画，解决闪烁根源 */
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            height: fit-content;
            position: relative;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            will-change: auto; /* 降低浏览器的渲染压力 */
            margin: 5px; /* 增加固定间距 */
            /* 防止点击时被选中 */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .memory-game .answer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }

        .memory-game .answer-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--clay-shadow-hover);
        }

        .memory-game .answer-card:hover::before {
            left: 100%;
        }

        .memory-game .answer-card.dragging {
            opacity: 0.8;
            transform: scale(0.95);
            transition: none;
            /* animation: clay-pulse 1s infinite; <-- 把这行删掉或加斜杠注释掉 */
        }

        /* 不同类型卡片的颜色 */
        .memory-game .answer-card.fraction {
            background: linear-gradient(145deg, var(--fraction-color), #5DB8EB);
        }

        .memory-game .answer-card.decimal {
            background: linear-gradient(145deg, var(--decimal-color), #FFC107);
        }

        .memory-game .answer-card.percent {
            background: linear-gradient(145deg, var(--percent-color), #A5A5FF);
        }

        /* 右侧：游戏表格 */
        .memory-game .table-section {
            flex: 2;
            border-radius: var(--clay-radius-lg);
            padding: 1.2rem;
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            background: var(--bg-white-90);
            display: flex;
            flex-direction: column;
            min-height: unset;      /* 关键 */
            height: auto;
        }

        /* 表格样式 - 加深格子线 */
        .memory-game .conversion-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.1rem;
            flex: 1;
            border-radius: var(--clay-radius-md);
            overflow: hidden;
            box-shadow: var(--clay-shadow);
            border: 1px solid var(--table-border);
            table-layout: fixed;
        }

        .memory-game .conversion-table th {
            background: linear-gradient(145deg, #6B7280, #4B5563);
            color: var(--text-white);
            padding: 12px;
            text-align: center;
            font-weight: 700;
            border-bottom: 2px solid var(--table-border-dark);
            border-right: 1px solid var(--table-border);
        }

        .memory-game .conversion-table th:last-child {
            border-right: none;
        }

        .memory-game .conversion-table td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid var(--table-border);
            border-right: 1px solid var(--table-border);
            background: var(--bg-white-80);
            vertical-align: top;
        }

        .memory-game .conversion-table td:last-child {
            border-right: none;
        }

        .memory-game .conversion-table tr:last-child td {
            border-bottom: none;
        }

        /* 固定单元格 - 粘土风格 */
        .memory-game .fixed-cell {
            font-weight: 700;
            font-size: 1.2rem;
            border-radius: var(--clay-radius-sm);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            position: relative;
            overflow: hidden;
        }

        .memory-game .fixed-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }

        .memory-game .fixed-cell.fraction {
            background: linear-gradient(145deg, rgba(135, 206, 235, 0.15), rgba(255, 255, 255, 0.9));
            color: #2E8B57;
        }

        .memory-game .fixed-cell.decimal {
            background: linear-gradient(145deg, rgba(255, 217, 61, 0.15), rgba(255, 255, 255, 0.9));
            color: #D4A017;
        }

        .memory-game .fixed-cell.percent {
            background: linear-gradient(145deg, rgba(209, 209, 255, 0.15), rgba(255, 255, 255, 0.9));
            color: #6A5ACD;
        }

        /* 可填充单元格 - 粘土风格 */
        .memory-game .drop-zone {
            min-height: 0;
            padding: 6px 4px;
            border-radius: var(--clay-radius-sm);
            border: 2px dashed var(--table-border);
            transition: all var(--transition-normal);
            position: relative;
            background: var(--bg-white-80);
            box-shadow: var(--clay-shadow);
        }

        .memory-game .drop-zone.fraction {
            background: linear-gradient(145deg, rgba(135, 206, 235, 0.1), rgba(255, 255, 255, 0.9));
        }

        .memory-game .drop-zone.decimal {
            background: linear-gradient(145deg, rgba(255, 217, 61, 0.1), rgba(255, 255, 255, 0.9));
        }

        .memory-game .drop-zone.percent {
            background: linear-gradient(145deg, rgba(209, 209, 255, 0.1), rgba(255, 255, 255, 0.9));
        }

        .memory-game .drop-zone.over {
            border-color: var(--drag-highlight-border);
            background: var(--drag-highlight-bg) !important;
            transform: none !important; /* 绝对不放大，表格就不会动了 */
        }

        /* 锁定答案方块在点击、活跃和拖拽时的位置 */
        .memory-game .answer-card:active,
        .memory-game .answer-card.dragging {
            transform: scale(0.98) !important; /* 允许轻微向内缩小（视觉反馈），但绝不产生位移 */
            box-shadow: none !important;      /* 移除阴影防止布局重绘 */
            position: relative;
            z-index: 100;
        }

        /* 移除任何可能导致表格抖动的过渡动画 */
        .memory-game .conversion-table,
        .memory-game .conversion-table td {
             transition: none !important; 
        }

        /* 正确状态 - 粘土风格 */
        .memory-game .drop-zone.correct {
            border-color: var(--clay-success);
            border-style: solid;
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(255, 255, 255, 0.9)) !important;
            box-shadow: var(--clay-shadow);
        }

        /* 错误状态 */
        .memory-game .drop-zone.incorrect {
            border-color: #ffa500;
            border-style: solid;
            background: linear-gradient(145deg, rgba(255, 165, 0, 0.1), rgba(255, 255, 255, 0.9)) !important;
        }

        /* 第四关的特殊样式 */
        .memory-game .level-4 .drop-zone.fraction,
        .memory-game .level-4 .drop-zone.decimal,
        .memory-game .level-4 .drop-zone.percent {
            background: var(--bg-white-80);
        }

        .memory-game .level-4 .row-correct td {
            border-left: 4px solid var(--clay-success);
            border-right: 4px solid var(--clay-success);
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(255, 255, 255, 0.9)) !important;
        }

        .memory-game .level-4 .row-correct td:first-child {
            border-left: 8px solid var(--clay-success);
        }

        .memory-game .level-4 .row-correct td:last-child {
            border-right: 8px solid var(--clay-success);
        }

        /* 控制按钮 */
        .memory-game .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .memory-game button {
            padding: 10px 25px;
            font-size: 0.9rem;
            font-weight: 700;
            border: none;
            border-radius: var(--clay-radius-sm);
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text-white);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            position: relative;
            overflow: hidden;
            min-width: 120px;
            touch-action: manipulation;
        }

        .memory-game button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }

        .memory-game button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--clay-shadow-hover);
        }

        .memory-game button:hover:not(:disabled)::before {
            left: 100%;
        }

        .memory-game button:active {
            transform: translateY(0);
            box-shadow: var(--clay-shadow-active);
        }

        .memory-game .reset-btn {
            background: linear-gradient(145deg, #87CEEB, #5DB8EB);
        }

        .memory-game .next-btn {
            background: linear-gradient(145deg, #94A3B8, #6B7280);
        }

        .memory-game .next-btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #6B7280, #4B5563);
        }

        .memory-game .next-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 消息提示 */
        .memory-game .message {
            text-align: center;
            padding: 12px;
            border-radius: var(--clay-radius-md);
            margin-top: 20px;
            font-weight: 600;
            display: none;
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
        }

        .memory-game .success-message {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(255, 255, 255, 0.9));
            color: #155724;
        }

        .memory-game .info-message {
            background: linear-gradient(145deg, rgba(13, 110, 253, 0.1), rgba(255, 255, 255, 0.9));
            color: var(--text-dark);
            margin-bottom: 15px;
            display: block;
            border: 2px solid rgba(13, 110, 253, 0.2);
        }

        /* 计分栏样式 - 修改为仅在移动端显示在表格下方 */
        .memory-game .stats {
            display: flex;
            justify-content: space-around;
            background: var(--bg-white-80);
            padding: 12px;
            border-radius: var(--clay-radius-md);
            margin-top: 20px;
            box-shadow: var(--clay-shadow);
            border: 1px solid var(--border-white);
        }

        .memory-game .stat-item {
            text-align: center;
        }

        .memory-game .stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-dark);
        }

        .memory-game .stat-label {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        /* 提示文字 */
        .memory-game .empty-cell-hint {
            font-size: 0.8rem;
            color: var(--text-medium);
            text-align: center;
            margin-top: 5px;
            font-style: italic;
            padding: 0.5rem;
            border-radius: var(--clay-radius-sm);
            background: var(--bg-white-80);
            box-shadow: var(--clay-shadow);
            border: 1px solid var(--border-white);
        }

        /* 如何玩游戏说明 */
        .memory-game .how-to-play {
            margin-top: 25px;
            padding: 15px;
            border-radius: var(--clay-radius-md);
            background: var(--bg-white-90);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
        }

        .memory-game .how-to-play h3 {
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
        }

        .memory-game .how-to-play-content {
            font-size: 0.95rem;
            color: var(--text-medium);
            line-height: 1.6;
        }

        .memory-game .how-to-play-content p {
            margin-bottom: 10px;
            max-width: none;
            text-align: left;
        }

        .memory-game .how-to-play-content ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .memory-game .how-to-play-content li {
            margin-bottom: 5px;
        }
        
        /* 文章容器样式 - 新增 */
        .article-container {
            margin-top: 25px;
            padding: 15px;
            border-radius: var(--clay-radius-md);
            background: var(--bg-white-90);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
        }

        .article-container h3 {
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: left;
            border-bottom: 2px solid var(--border-white);
            padding-bottom: 5px;
            margin-top: 20px;
        }

        .article-container h3:first-child {
            margin-top: 0;
        }

        .article-container p, .article-container ul {
            font-size: 0.95rem;
            color: var(--text-medium);
            line-height: 1.6;
            margin-bottom: 10px;
            text-align: left;
        }

        .article-container ul {
            margin-left: 20px;
        }

        .article-container li {
            margin-bottom: 5px;
        }

        /* Start按钮样式 - 新增 */
        .start-button {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 15px;
            background: linear-gradient(145deg, #87CEEB, #5DB8EB);
            color: white;
            text-decoration: none;
            font-weight: bold;
            border-radius: var(--clay-radius-sm);
            box-shadow: var(--clay-shadow);
            border: 2px solid var(--border-white);
            transition: all var(--transition-normal);
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--clay-shadow-hover);
            background: linear-gradient(145deg, #5DB8EB, #87CEEB);
        }

        /* 拖拽幽灵元素样式 */
        .drag-ghost {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important;
            pointer-events: none !important;
            z-index: 9999 !important;
            opacity: 0.9 !important;
            transition: none !important;
            transform-origin: center !important;
            will-change: transform;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.12));
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translate3d(0, 0, 0) scale(1.05);
        }

        /* 动画效果 */
        @keyframes clay-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.6; }
        }

        @keyframes success-pop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.03); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translate3d(0, 0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 40%, 60%, 80% { transform: translate3d(2px, 0, 0); }
        }

        /* ====== 移动端响应式布局 ====== */
        @media (max-width: 1024px) {
            .memory-game .game-container {
                flex-direction: column;
            }
            
            .memory-game .answers-section, .memory-game .table-section {
                min-height: auto;
            }
            
            /* 在移动端，将计分栏移动到表格下方 */
            .answers-section .stats {
                display: none; /* 隐藏答案栏中的计分栏 */
            }
            
            /* 在表格容器内添加移动端计分栏 */
            .table-section::after {
                content: '';
                display: table;
                clear: both;
            }
            
            /* 移动端计分栏样式 */
            .mobile-stats {
                display: flex !important;
                justify-content: space-around;
                background: var(--bg-white-80);
                padding: 12px;
                border-radius: var(--clay-radius-md);
                margin-top: 15px;
                box-shadow: var(--clay-shadow);
                border: 1px solid var(--border-white);
            }
        }
        
        /* 桌面端保持原有布局 */
        @media (min-width: 1025px) {
            .mobile-stats {
                display: none !important; /* 桌面端隐藏移动端计分栏 */
            }
            
            .answers-section .stats {
                display: flex; /* 桌面端显示答案栏中的计分栏 */
            }
        }
        
        @media (max-width: 768px) {
            .memory-game .memory-game-container {
                padding: 1rem;
            }
            
            .memory-game h1 {
                font-size: 1.6rem;
            }
            
            .memory-game .conversion-table {
                font-size: 0.9rem;
            }
            
            .memory-game .conversion-table td, .memory-game .conversion-table th {
                padding: 10px 8px;
            }
            
            .memory-game .answer-card {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .memory-game .controls {
                flex-wrap: wrap;
            }
            
            .memory-game button {
                flex: 1;
                min-width: 110px;
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            
            .memory-game .how-to-play {
                padding: 12px;
            }
            
            .memory-game .how-to-play h3 {
                font-size: 1.1rem;
            }
            
            .memory-game .how-to-play-content {
                font-size: 0.9rem;
            }
            
            /* 响应式调整文章容器 */
            .article-container {
                padding: 12px;
            }
            
            .article-container h3 {
                font-size: 1.1rem;
            }
            
            .article-container p, .article-container ul {
                font-size: 0.9rem;
            }
            
            .start-button {
                display: block;
                margin: 10px auto 5px auto;
                text-align: center;
                width: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .memory-game .memory-game-container {
                padding: 0.8rem;
            }
            
            .memory-game h1 {
                font-size: 1.4rem;
            }
            
            .memory-game .answer-card {
                padding: 7px 10px;
                font-size: 0.8rem;
            }
            
            .memory-game .conversion-table td, .memory-game .conversion-table th {
                padding: 8px 5px;
            }
            
            .memory-game .controls {
                gap: 0.5rem;
            }
            
            .memory-game button {
                max-width: 140px;
                padding: 7px 14px;
                font-size: 0.75rem;
                min-width: 100px;
            }
            
            .memory-game .how-to-play {
                padding: 10px;
            }
            
            .memory-game .how-to-play h3 {
                font-size: 1rem;
            }
            
            .memory-game .how-to-play-content {
                font-size: 0.85rem;
            }
            
            .article-container {
                padding: 10px;
            }
            
            .article-container h3 {
                font-size: 1rem;
            }
            
            .article-container p, .article-container ul {
                font-size: 0.85rem;
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-row {
                flex-direction: column;
            }
            
            .left-sidebar, .right-sidebar {
                flex: 1;
            }
            
            .main-title {
                font-size: 1.8rem;
                flex-direction: column;
                align-items: center;
            }
            
            .nded-text {
                font-size: 1.98rem;
                margin-right: 0;
                margin-bottom: 4.5px;
                height: 45px;
            }
            
            .subtitle {
                font-size: 1.26rem;
                margin-left: 0;
                text-align: center;
                height: auto;
                line-height: 1.3;
                display: block;
                margin-top: 4.5px;
            }
            
            header {
                flex-direction: column;
                padding: 0.45rem 0;
                min-height: 108px;
            }
            
            /* 导航按钮在移动端改为每行2个 */
            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.675rem;
            }
            
            .nav-button {
                font-size: 0.855rem;
                padding: 0.675rem 0.45rem;
            }
        }
        
        @media (max-width: 480px) {
            /* 导航按钮在小屏幕设备上的调整 */
            .nav-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.54rem;
            }
            
            .nav-button {
                font-size: 0.81rem;
                padding: 0.585rem 0.36rem;
            }
        }
    </style>
</head>
<body>
    <!-- 页眉部分 -->
    <header>
        <div class="container">
            <h1 class="main-title">
                <span class="nded-text">NDED</span>
                <span class="subtitle">building mathematical confidence for life.</span>
            </h1>
        </div>
    </header>
    
    <!-- 主内容区域 -->
    <div class="main-row-container">
        <div class="wide-container">
            <div class="main-row">
                <!-- 左侧边栏 -->
                <div class="left-sidebar">
                    <h3 class="nav-title">Navigation</h3>
                    <div class="nav-buttons">
                        <a href="../index.html" class="nav-button">Home</a>
                        <a href="about-us.html" class="nav-button">About us</a>
                        <a href="#content" class="nav-button">Content</a>
                        <a href="https://matrixcalcu.com/" target="_blank" class="nav-button external">Matrix Calculator</a>
                    </div>
                </div>
                
                <!-- 主内容区域 - 游戏将放在这里 -->
                <div class="main-content">
                    <div class="dynamic-content-container">
                        
                        <!-- 游戏容器 -->
                        <div class="memory-game-container memory-game-root" id="game-container">
                            <div class="memory-game">
                                <div class="header">
                                    <h1>Fraction, Decimal & Percent Memory Game</h1>
                                    <div class="game-info">
                                        <div class="game-status">
                                            <span id="levelDescription">Level 1: Fraction to Decimal & Percent</span>
                                            <span class="level-indicator">Round <span id="roundNumber">1</span> of 2</span>
                                        </div>
                                        <div class="game-status">
                                            Filled: <span id="filledCount">0</span> of <span id="totalCount">16</span>
                                        </div>
                                    </div>
                                    
                                    <div class="level-selector" id="levelSelector">
                                        <button class="level-btn active" data-level="1">Level 1</button>
                                        <button class="level-btn" data-level="2">Level 2</button>
                                        <button class="level-btn" data-level="3">Level 3</button>
                                        <button class="level-btn" data-level="4">Level 4</button>
                                    </div>
                                </div>
                                
                                <div class="game-container">
                                    <div class="answers-section">
                                        <h2 class="section-title">Answer Bank</h2>
                                        <div class="answers-container" id="answersContainer">
                                            <!-- Answer cards will be generated here -->
                                        </div>
                                        
                                        <!-- 桌面端计分栏 -->
                                        <div class="stats">
                                            <div class="stat-item">
                                                <div class="stat-value" id="correctCount">0</div>
                                                <div class="stat-label">Correct</div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-value" id="incorrectCount">0</div>
                                                <div class="stat-label">Needs Review</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-section" id="tableSection">
                                        <h2 class="section-title">Conversion Table</h2>
                                        <table class="conversion-table">
                                            <thead>
                                                <tr>
                                                    <th width="33%">Fraction</th>
                                                    <th width="33%">Decimal</th>
                                                    <th width="34%">Percent</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                <!-- Table rows will be generated here -->
                                            </tbody>
                                        </table>
                                        <p class="empty-cell-hint" id="hintText">Drag answers from the left panel to the empty cells above</p>
                                        
                                        <div class="controls">
                                            <button class="reset-btn" id="resetBtn">Reset Round</button>
                                            <button class="next-btn" id="nextBtn" disabled>Next Round</button>
                                        </div>
                                        
                                        <!-- 移动端计分栏 -->
                                        <div class="mobile-stats" style="display: none;">
                                            <div class="stat-item">
                                                <div class="stat-value" id="mobileCorrectCount">0</div>
                                                <div class="stat-label">Correct</div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-value" id="mobileIncorrectCount">0</div>
                                                <div class="stat-label">Needs Review</div>
                                            </div>
                                        </div>
                                        
                                        <div class="message success-message" id="successMessage">
                                            <p>Excellent! All answers are correct.</p>
                                            <p>You can continue practicing or click "Next Round" to continue.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 如何玩游戏说明 -->
                                <div class="how-to-play">
                                    <h3>How to Play</h3>
                                    <div class="how-to-play-content">
                                        <p><strong>Goal:</strong> Match equivalent fractions, decimals, and percentages in the conversion table.</p>
                                        <p><strong>How to play:</strong> Drag answer cards from the Answer Bank to the empty cells in the table. Each row must contain three equivalent values.</p>
                                        <p><strong>Levels:</strong></p>
                                        <ul>
                                            <li><strong>Level 1:</strong> Given fractions, match the corresponding decimals and percents.</li>
                                            <li><strong>Level 2:</strong> Given decimals, match the corresponding fractions and percents.</li>
                                            <li><strong>Level 3:</strong> Given percents, match the corresponding fractions and decimals.</li>
                                            <li><strong>Level 4:</strong> All cells are empty. Match three equivalent values in each row.</li>
                                        </ul>
                                        <p><strong>Tips:</strong> You can move cards around to correct mistakes. When all cells are filled correctly, you can proceed to the next round!</p>
                                    </div>
                                </div>
                                
                                <!-- 文章内容 -->
                                <div class="article-container">
                                    <h3>What Are Fractions, Decimals, and Percents?</h3>
                                    <p>Fractions, decimals, and percents are three different ways to represent the same numerical value.</p>
                                    <p>For example:</p>
                                    <ul>
                                        <li>1/2</li>
                                        <li>0.5</li>
                                        <li>50%</li>
                                    </ul>
                                    <p>All three represent the same amount, but in different forms.</p>
                                    <p>In math learning and everyday life, students are expected to move easily between fractions, decimals, and percents—whether they are calculating discounts, understanding ratios, or solving word problems.</p>
                                    <p>Difficulty with these conversions often slows students down and increases math anxiety.</p>

                                    <h3>What Is the Fraction, Decimal, and Percent Memory Game?</h3>
                                    <p>The Fraction, Decimal, and Percent Memory Game is a free interactive math game designed to build fluency and instant recognition, not step-by-step calculation.</p>
                                    <p>Instead of focusing on long procedures, this game helps learners form strong mental connections between fractions, decimals, and percents, so that:</p>
                                    <ul>
                                        <li>Seeing one form immediately triggers the other two</li>
                                        <li>Conversions become fast and automatic</li>
                                        <li>Less mental effort is spent on basic recognition</li>
                                    </ul>
                                    <p>This type of fluency allows students to focus on understanding and problem-solving rather than calculation mechanics.</p>

                                    <h3>How Does the Game Work?</h3>
                                    <p>The game includes four progressive levels, each designed to strengthen conversion skills from a different starting point:</p>
                                    <ul>
                                        <li><strong>Level 1</strong><br>A fraction is given. Players drag and place the matching decimal and percent.</li>
                                        <li><strong>Level 2</strong><br>A decimal is given. Players complete the corresponding fraction and percent.</li>
                                        <li><strong>Level 3</strong><br>A percent is given. Players complete the corresponding fraction and decimal.</li>
                                        <li><strong>Level 4</strong><br>All three fields are empty. Players drag the correct fraction, decimal, and percent into their matching positions.</li>
                                    </ul>
                                    <p>The game provides instant visual feedback.<br>Answers can be adjusted freely, allowing players to recognize mistakes and correct them independently. When all matches are correct, the game automatically moves to the next round.</p>
                                    <p>This low-pressure design supports confidence, accuracy, and long-term memory.</p>

                                    <h3>Who Created This Game? Is It Free?</h3>
                                    <p>The Fraction, Decimal, and Percent Memory Game was developed by NDED Education Group.</p>
                                    <p>NDED's mission is to rethink how mathematics is learned by combining technology, game-based design, and structured practice to help students build strong foundations with less stress and more confidence.</p>
                                    <p>This game is completely free to use.</p>

                                    <h3>How Can This Game Be Used?</h3>
                                    <p>This free online math game is suitable for:</p>
                                    <ul>
                                        <li>Upper elementary and middle school students</li>
                                        <li>Learners who need extra practice with fractions, decimals, and percents</li>
                                        <li>Parents supporting math practice at home</li>
                                        <li>Teachers using interactive tools for classroom or review activities</li>
                                    </ul>
                                    <p>Short, repeated practice sessions are recommended. Even a few minutes at a time can significantly improve math fluency and speed.</p>

                                    <h3>Do I Need to Register or Log In?</h3>
                                    <p>No.<br>This fraction, decimal, and percent practice game does not require registration or login.</p>
                                    <p>Players can start practicing immediately. <a href="#game-container" class="start-button">Start</a></p>

                                    <h3>Feedback and Suggestions</h3>
                                    <p>We welcome feedback, suggestions, and bug reports from users around the world.</p>
                                    <p>NDED Education Group is committed to continuously improving this fraction, decimal, and percent conversion game and expanding it with additional fluency-based math tools.</p>
                                    <p>If you would like to share your experience, please contact us at:<br>
                                    <strong>info@nd-ed.org</strong></p>
                                    <p>Your feedback helps us build better learning tools for everyone.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧边栏 -->
                <div class="right-sidebar">
                    <div class="question-box">
                        <h2>Do you enjoy learning math?</h2>
                        <button class="btn yes">Yes, I love math!</button>
                        <button class="btn no">Math is challenging for me</button>
                        <div class="response" id="response"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 页脚部分 -->
    <footer>
        <div class="container">
            <p>&copy; 2026 NDED - Building Mathematical Confidence for Life. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript代码 -->
    <script>
        // 问答栏功能
        function initPoll() {
            const yesBtn = document.querySelector('.question-box .yes');
            const noBtn = document.querySelector('.question-box .no');
            const response = document.getElementById('response');

            yesBtn.addEventListener('click', () => {
                response.textContent = "That's great! Math is an amazing tool for understanding the world! 🧮";
                response.classList.add('show');
            });

            noBtn.addEventListener('click', () => {
                response.textContent = "We're here to help! Our resources are designed to make math easier and more fun. 👍";
                response.classList.add('show');
            });
        }

        // ====== 游戏JavaScript代码 ======
        // 注意：这里包含完整的游戏逻辑，但由于长度限制，我们将使用之前优化过的游戏代码
        
        // 游戏数据 - fraction, decimal, percent equivalents
        const gameData = [
            { fraction: '1/2', decimal: '0.5', percent: '50%' },
            { fraction: '1/4', decimal: '0.25', percent: '25%' },
            { fraction: '3/4', decimal: '0.75', percent: '75%' },
            { fraction: '1/5', decimal: '0.2', percent: '20%' },
            { fraction: '1/10', decimal: '0.1', percent: '10%' },
            { fraction: '1/8', decimal: '0.125', percent: '12.5%' },
            { fraction: '1/3', decimal: '0.333…', percent: '33⅓%' },
            { fraction: '2/3', decimal: '0.666…', percent: '66⅔%' }
        ];

        // 关卡配置
        const levelConfigs = {
            1: { // Level 1: Fraction to Decimal & Percent
                fixedColumn: 'fraction',
                answerTypes: ['decimal', 'percent'],
                description: 'Fraction to Decimal & Percent',
                hint: 'Drag answers from the left panel to the empty cells above'
            },
            2: { // Level 2: Decimal to Fraction & Percent
                fixedColumn: 'decimal',
                answerTypes: ['fraction', 'percent'],
                description: 'Decimal to Fraction & Percent',
                hint: 'Drag answers from the left panel to the empty cells above'
            },
            3: { // Level 3: Percent to Fraction & Decimal
                fixedColumn: 'percent',
                answerTypes: ['fraction', 'decimal'],
                description: 'Percent to Fraction & Decimal',
                hint: 'Drag answers from the left panel to the empty cells above'
            },
            4: { // Level 4: All values mixed
                fixedColumn: null,
                answerTypes: ['fraction', 'decimal', 'percent'],
                description: 'All Values Mixed',
                hint: 'Drag answers to match equivalent values in each row'
            }
        };

        // Game state
        let gameState = {
            currentLevel: 1,
            currentRound: 1,
            totalRounds: 2,
            filledCells: 0,
            correctRows: 0,
            correctCells: 0,
            incorrectCells: 0,
            totalCells: 0,
            totalRows: gameData.length,
            draggedCard: null,
            isCompleted: false,
            cardLocations: {}
        };

        // DOM elements
        const answersContainer = document.getElementById('answersContainer');
        const tableBody = document.getElementById('tableBody');
        const tableSection = document.getElementById('tableSection');
        const resetBtn = document.getElementById('resetBtn');
        const nextBtn = document.getElementById('nextBtn');
        const successMessage = document.getElementById('successMessage');
        const roundNumber = document.getElementById('roundNumber');
        const filledCount = document.getElementById('filledCount');
        const totalCount = document.getElementById('totalCount');
        const correctCount = document.getElementById('correctCount');
        const incorrectCount = document.getElementById('incorrectCount');
        const levelDescription = document.getElementById('levelDescription');
        const hintText = document.getElementById('hintText');
        const levelSelector = document.getElementById('levelSelector');
        const mobileCorrectCount = document.getElementById('mobileCorrectCount');
        const mobileIncorrectCount = document.getElementById('mobileIncorrectCount');

        // ====== 拖拽管理器（修复版） ======
        const dragManager = {
            // 状态
            isDragging: false,
            currentElement: null,
            ghostElement: null,
            dragCardId: null,
            dragCardType: null,
            dragCardValue: null,
            startX: 0,
            startY: 0,
            offsetX: 0,
            offsetY: 0,
            currentX: 0,
            currentY: 0,
            
            // 预缓存的拖放区域数据
            dropZones: [],
            answerBankZone: null,
            lastHighlightedZone: null,
            
            // 动画帧ID（用于requestAnimationFrame节流）
            animationFrameId: null,
            pendingUpdate: false,
            
            // 初始化拖拽管理器
            init: function() {
                this.cacheDropZones();
                
                // 监听窗口大小变化，重新缓存拖放区域
                window.addEventListener('resize', () => {
                    this.cacheDropZones();
                });
                
                // 监听页面滚动，重新缓存拖放区域
                window.addEventListener('scroll', () => {
                    this.cacheDropZones();
                }, { passive: true });
            },
            
            // 预缓存所有可拖放区域的位置信息
            cacheDropZones: function() {
                // 缓存表格中的拖放区域
                const tableDropZones = document.querySelectorAll('.drop-zone');
                this.dropZones = Array.from(tableDropZones).map(zone => {
                    const rect = zone.getBoundingClientRect();
                    
                    return {
                        element: zone,
                        rect: {
                            x: rect.left,
                            y: rect.top,
                            right: rect.right,
                            bottom: rect.bottom,
                            width: rect.width,
                            height: rect.height,
                            centerX: rect.left + rect.width / 2,
                            centerY: rect.top + rect.height / 2
                        },
                        type: zone.getAttribute('data-type'),
                        rowIndex: zone.getAttribute('data-row-index'),
                        expectedValue: zone.getAttribute('data-expected'),
                        isFilled: zone.getAttribute('data-filled') === 'true'
                    };
                });
                
                // 缓存答案栏区域
                if (answersContainer) {
                    const rect = answersContainer.getBoundingClientRect();
                    this.answerBankZone = {
                        element: answersContainer,
                        rect: {
                            x: rect.left,
                            y: rect.top,
                            right: rect.right,
                            bottom: rect.bottom,
                            width: rect.width,
                            height: rect.height,
                            centerX: rect.left + rect.width / 2,
                            centerY: rect.top + rect.height / 2
                        }
                    };
                }
            },
            
            // 开始拖拽（修复：不再修改body样式）
            startDrag: function(element, clientX, clientY) {
                // 检查是否是答案卡片
                if (!element.classList.contains('answer-card')) {
                    return false;
                }
                
                // 获取卡片信息
                const cardId = element.id;
                const cardType = element.getAttribute('data-type');
                const cardValue = element.getAttribute('data-value');
                
                this.isDragging = true;
                this.currentElement = element;
                this.dragCardId = cardId;
                this.dragCardType = cardType;
                this.dragCardValue = cardValue;
                
                // 获取元素位置
                const rect = element.getBoundingClientRect();
                this.startX = clientX;
                this.startY = clientY;
                this.offsetX = clientX - rect.left;
                this.offsetY = clientY - rect.top;
                this.currentX = rect.left;
                this.currentY = rect.top;
                
                // 创建拖拽幽灵
                this.createDragGhost(element, rect);
                
                // 标记原始元素为拖拽中
                element.classList.add('dragging');
                
                // 添加全局事件监听（使用Pointer Events）
                document.addEventListener('pointermove', this.handlePointerMove.bind(this), { passive: false });
                document.addEventListener('pointerup', this.handlePointerUp.bind(this), { passive: false });
                document.addEventListener('pointercancel', this.handlePointerCancel.bind(this), { passive: false });
                
                // 不再修改body样式，防止页面跳动
                // document.body.style.userSelect = 'none';
                // document.body.style.overflow = 'hidden';
                
                return true;
            },
            
            // 创建高性能拖拽幽灵
            createDragGhost: function(sourceElement, sourceRect) {
                // 创建幽灵元素
                this.ghostElement = sourceElement.cloneNode(true);
                this.ghostElement.classList.add('drag-ghost');
                this.ghostElement.classList.remove('dragging');
                
                // 应用样式
                const style = window.getComputedStyle(sourceElement);
                
                // 设置基础样式
                this.ghostElement.style.width = `${sourceRect.width}px`;
                this.ghostElement.style.height = `${sourceRect.height}px`;
                
                // 确保position: fixed
                this.ghostElement.style.position = 'fixed';
                this.ghostElement.style.left = '0';
                this.ghostElement.style.top = '0';
                this.ghostElement.style.margin = '0';
                
                // 复制关键样式
                this.ghostElement.style.background = style.background;
                this.ghostElement.style.color = style.color;
                this.ghostElement.style.fontSize = style.fontSize;
                this.ghostElement.style.fontWeight = style.fontWeight;
                this.ghostElement.style.borderRadius = style.borderRadius;
                this.ghostElement.style.boxShadow = style.boxShadow;
                this.ghostElement.style.border = style.border;
                this.ghostElement.style.display = 'flex';
                this.ghostElement.style.justifyContent = 'center';
                this.ghostElement.style.alignItems = 'center';
                this.ghostElement.style.zIndex = '9999';
                
                // 设置初始位置到屏幕外
                this.ghostElement.style.transform = `translate3d(-1000px, -1000px, 0)`;
                
                // 添加到文档
                document.body.appendChild(this.ghostElement);
                
                // 强制同步布局
                this.ghostElement.offsetHeight;
                
                // 立即移动到正确位置
                const transformX = this.startX - this.offsetX;
                const transformY = this.startY - this.offsetY;
                this.ghostElement.style.transform = 
                    `translate3d(${transformX}px, ${transformY}px, 0) scale(1.05)`;
                
                // 强制重绘
                this.ghostElement.getBoundingClientRect();
            },
            
            // 指针移动处理（使用requestAnimationFrame节流）
            handlePointerMove: function(e) {
                if (!this.isDragging) return;
                
                // 关键修复：阻止默认行为，防止页面滚动
                e.preventDefault();
                e.stopPropagation();
                
                // 更新当前位置
                this.currentX = e.clientX - this.offsetX;
                this.currentY = e.clientY - this.offsetY;
                
                // 使用requestAnimationFrame节流更新
                if (!this.pendingUpdate) {
                    this.pendingUpdate = true;
                    this.animationFrameId = requestAnimationFrame(() => {
                        this.updateDragPosition(e.clientX, e.clientY);
                        this.pendingUpdate = false;
                    });
                }
            },
            
            // 更新拖拽位置（GPU加速）
            updateDragPosition: function(clientX, clientY) {
                if (!this.isDragging || !this.ghostElement) return;
                
                // 计算transform位置
                const transformX = clientX - this.offsetX;
                const transformY = clientY - this.offsetY;
                
                // 使用transform3d进行GPU加速
                this.ghostElement.style.transform = 
                    `translate3d(${transformX}px, ${transformY}px, 0) scale(1.05)`;
                
                // 碰撞检测
                this.checkDropZoneCollision(clientX, clientY);
            },
            
            // 碰撞检测（使用预缓存的数据）
            checkDropZoneCollision: function(x, y) {
                let currentZone = null;
                let minDistance = Infinity;
                
                // 首先检查答案栏区域
                if (this.answerBankZone) {
                    const bankZone = this.answerBankZone;
                    if (x >= bankZone.rect.x && x <= bankZone.rect.right &&
                        y >= bankZone.rect.y && y <= bankZone.rect.bottom) {
                        currentZone = bankZone;
                    }
                }
                
                // 如果没有在答案栏区域，检查表格中的拖放区域
                if (!currentZone) {
                    for (const zone of this.dropZones) {
                        // 跳过已填充的区域
                        if (zone.isFilled) continue;
                        
                        // 对于前3关，检查卡片类型是否匹配单元格类型
                        if (gameState.currentLevel !== 4) {
                            const config = levelConfigs[gameState.currentLevel];
                            const isAllowedType = config.answerTypes.includes(this.dragCardType);
                            const isMatchingType = this.dragCardType === zone.type;
                            
                            // 如果卡片类型不在当前关卡的答案类型中，或者类型不匹配，跳过
                            if (!isAllowedType || !isMatchingType) {
                                continue;
                            }
                        }
                        
                        // 快速矩形碰撞检测
                        if (x >= zone.rect.x && x <= zone.rect.right &&
                            y >= zone.rect.y && y <= zone.rect.bottom) {
                            
                            // 计算到中心点的距离
                            const distance = Math.sqrt(
                                Math.pow(x - zone.rect.centerX, 2) + 
                                Math.pow(y - zone.rect.centerY, 2)
                            );
                            
                            // 选择最近的区域
                            if (distance < minDistance) {
                                minDistance = distance;
                                currentZone = zone;
                            }
                        }
                    }
                }
                
                // 更新高亮显示
                this.updateDropZoneHighlight(currentZone);
            },
            
            // 更新拖放区域高亮
            updateDropZoneHighlight: function(zone) {
                // 清除之前的高亮
                if (this.lastHighlightedZone && this.lastHighlightedZone !== zone) {
                    this.lastHighlightedZone.element.classList.remove('over');
                }
                
                // 设置新的高亮
                if (zone && zone !== this.lastHighlightedZone) {
                    zone.element.classList.add('over');
                    this.lastHighlightedZone = zone;
                } else if (!zone && this.lastHighlightedZone) {
                    this.lastHighlightedZone.element.classList.remove('over');
                    this.lastHighlightedZone = null;
                }
            },
            
            // 结束拖拽
            handlePointerUp: function(e) {
                if (!this.isDragging) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // 获取放置位置
                const dropZone = this.lastHighlightedZone;
                
                if (dropZone) {
                    // 如果是答案栏区域
                    if (dropZone.element.id === 'answersContainer') {
                        // 放回答案栏
                        this.handleReturnToBank();
                    } 
                    // 如果是表格中的拖放区域
                    else if (dropZone.element.classList.contains('drop-zone')) {
                        // 处理放置到表格单元格
                        this.handleDropToTableCell(dropZone);
                    }
                }
                
                // 清理拖拽状态
                this.endDrag();
            },
            
            // 取消拖拽
            handlePointerCancel: function() {
                if (!this.isDragging) return;
                this.endDrag();
            },
            
            // 放回答案栏处理
            handleReturnToBank: function() {
                // 获取原始卡片
                const card = document.getElementById(this.dragCardId);
                if (!card) return;
                
                // 调用现有的returnToAnswerBank函数
                returnToAnswerBank(card);
            },
            
            // 放置到表格单元格处理
            handleDropToTableCell: function(dropZone) {
                // 获取原始卡片
                const card = document.getElementById(this.dragCardId);
                if (!card) return;
                
                // 调用现有的dropToTableCell函数
                dropToTableCell(card, dropZone.element);
            },
            
            // 结束拖拽（清理）
            endDrag: function() {
                if (!this.isDragging) return;
                
                this.isDragging = false;
                
                // 取消动画帧
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                
                // 移除幽灵元素
                if (this.ghostElement) {
                    this.ghostElement.remove();
                    this.ghostElement = null;
                }
                
                // 清除原始元素的拖拽状态
                if (this.currentElement) {
                    this.currentElement.classList.remove('dragging');
                    this.currentElement = null;
                }
                
                // 清除拖放区域高亮
                if (this.lastHighlightedZone) {
                    this.lastHighlightedZone.element.classList.remove('over');
                    this.lastHighlightedZone = null;
                }
                
                // 移除全局事件监听
                document.removeEventListener('pointermove', this.handlePointerMove.bind(this));
                document.removeEventListener('pointerup', this.handlePointerUp.bind(this));
                document.removeEventListener('pointercancel', this.handlePointerCancel.bind(this));
                
                // 不再需要恢复body样式
                // document.body.style.userSelect = '';
                // document.body.style.overflow = '';
                
                // 重置状态
                this.dragCardId = null;
                this.dragCardType = null;
                this.dragCardValue = null;
                this.pendingUpdate = false;
            }
        };

        // Initialize the game
        function initGame() {
            // Clear previous content
            answersContainer.innerHTML = '';
            tableBody.innerHTML = '';
            successMessage.style.display = 'none';
            gameState.filledCells = 0;
            gameState.correctCells = 0;
            gameState.correctRows = 0;
            gameState.incorrectCells = 0;
            gameState.isCompleted = false;
            gameState.cardLocations = {};
            gameState.draggedCard = null;
            
            // 根据当前关卡设置总单元格数
            const config = levelConfigs[gameState.currentLevel];
            gameState.totalCells = gameData.length * config.answerTypes.length;
            
            // 更新表格区域类名 - 为第四关添加特殊类名
            updateTableSectionClass();
            
            // Update UI elements
            updateGameInfo();
            
            // Update next button state
            nextBtn.disabled = true;
            
            // 更新Next按钮文本
            updateNextButtonText();
            
            // Create answer cards
            createAnswerCards();
            
            // Create table with appropriate fixed column
            createTable();
            
            // Update counts
            updateCounts();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update level selector
            updateLevelSelector();
            
            // 初始化拖拽管理器的缓存
            setTimeout(() => {
                dragManager.cacheDropZones();
            }, 100);
        }

        // 更新表格区域类名，为第四关添加特殊样式
        function updateTableSectionClass() {
            // 移除所有可能存在的关卡类名
            tableSection.classList.remove('level-1', 'level-2', 'level-3', 'level-4');
            
            // 为当前关卡添加类名
            tableSection.classList.add(`level-${gameState.currentLevel}`);
        }

        // Create answer cards for dragging
        function createAnswerCards() {
            const config = levelConfigs[gameState.currentLevel];
            
            // 收集所有需要的答案
            let allAnswers = [];
            
            config.answerTypes.forEach(type => {
                gameData.forEach(item => {
                    allAnswers.push({ 
                        type: type, 
                        value: item[type],
                        // 存储对应的其他值以便验证
                        expected: {
                            fraction: item.fraction,
                            decimal: item.decimal,
                            percent: item.percent
                        }
                    });
                });
            });
            
            // For round 1: ordered answers (by type)
            // For round 2: shuffled answers
            if (gameState.currentRound === 2) {
                allAnswers = shuffleArray(allAnswers);
            }
            
            // Create answer cards in the container
            allAnswers.forEach(answer => {
                // 创建唯一的ID，确保即使值相同，类型不同也能区分
                const cardId = `card-${answer.type}-${answer.value.replace(/[^a-zA-Z0-9]/g, '')}-${Math.random().toString(36).substr(2, 9)}`;
                
                const card = document.createElement('div');
                card.className = `answer-card ${answer.type} in-bank`;
                card.textContent = answer.value;
                card.setAttribute('data-type', answer.type);
                card.setAttribute('data-value', answer.value);
                // 存储完整数据以便验证
                card.setAttribute('data-fraction', answer.expected.fraction);
                card.setAttribute('data-decimal', answer.expected.decimal);
                card.setAttribute('data-percent', answer.expected.percent);
                card.setAttribute('id', cardId);
                
                // 关键修复：添加touchstart事件监听，阻止默认行为
                card.addEventListener('touchstart', function(e) {
                    // 阻止触摸事件的默认行为（滚动、缩放等）
                    e.preventDefault();
                    e.stopPropagation();
                }, { passive: false });
                
                // 添加Pointer Events监听器（移动端）
                card.addEventListener('pointerdown', handlePointerStart);
                
                // 为了兼容性，保留原有的dragstart事件（PC端）
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                
                answersContainer.appendChild(card);
                
                // Track card location
                gameState.cardLocations[cardId] = 'bank';
            });
        }

        // Create the conversion table based on current level
        function createTable() {
            const config = levelConfigs[gameState.currentLevel];
            
            gameData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.setAttribute('data-row-index', index);
                row.setAttribute('data-fraction', item.fraction);
                row.setAttribute('data-decimal', item.decimal);
                row.setAttribute('data-percent', item.percent);
                
                // 创建三列
                const columnTypes = ['fraction', 'decimal', 'percent'];
                columnTypes.forEach(columnType => {
                    const cell = document.createElement('td');
                    
                    if (columnType === config.fixedColumn) {
                        // 固定列：显示已知值
                        cell.className = `fixed-cell ${columnType}`;
                        cell.textContent = item[columnType];
                        cell.setAttribute('data-type', columnType);
                        cell.setAttribute('data-value', item[columnType]);
                    } else {
                        // 可拖放区域
                        cell.className = `drop-zone ${columnType}`;
                        cell.setAttribute('data-type', columnType);
                        cell.setAttribute('data-expected', item[columnType]);
                        cell.setAttribute('data-row-index', index);
                        cell.setAttribute('data-filled', 'false');
                        
                        // 为了兼容性，保留原有的拖放事件（PC端）
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                        
                        // 对于第四关，所有单元格都是可拖放的
                        if (gameState.currentLevel === 4) {
                            cell.setAttribute('data-expected', ''); // 第四关不需要预期值
                        }
                    }
                    
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
        }

        // Update game information display
        function updateGameInfo() {
            const config = levelConfigs[gameState.currentLevel];
            
            roundNumber.textContent = gameState.currentRound;
            totalCount.textContent = gameState.totalCells;
            
            // Update level description
            levelDescription.textContent = `Level ${gameState.currentLevel}: ${config.description}`;
            
            // Update hint
            hintText.textContent = config.hint;
            
            // 更新关卡选择器
            updateLevelSelector();
        }
        
        // 更新Next按钮文本
        function updateNextButtonText() {
            if (gameState.currentLevel === 4 && gameState.currentRound === 2 && gameState.isCompleted) {
                // 第四关第二回合完成时，按钮显示为"Practice Again"
                nextBtn.textContent = 'Practice Again';
            } else {
                // 其他情况下显示"Next Round"
                nextBtn.textContent = 'Next Round';
            }
        }

        // Update level selector buttons
        function updateLevelSelector() {
            document.querySelectorAll('.level-btn').forEach(btn => {
                const level = parseInt(btn.getAttribute('data-level'));
                if (level === gameState.currentLevel) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Update all counts
        function updateCounts() {
            const config = levelConfigs[gameState.currentLevel];
            
            filledCount.textContent = gameState.filledCells;
            
            // 根据关卡类型显示不同的正确计数
            if (gameState.currentLevel === 4) {
                // 第四关：显示正确的行数
                correctCount.textContent = gameState.correctRows;
                incorrectCount.textContent = gameState.totalRows - gameState.correctRows;
                
                // 更新移动端计分栏
                if (mobileCorrectCount) mobileCorrectCount.textContent = gameState.correctRows;
                if (mobileIncorrectCount) mobileIncorrectCount.textContent = gameState.totalRows - gameState.correctRows;
                
                // 检查是否完成：所有行都正确
                if (gameState.filledCells === gameState.totalCells && gameState.correctRows === gameState.totalRows) {
                    gameState.isCompleted = true;
                    successMessage.style.display = 'block';
                    nextBtn.disabled = false;
                    
                    // 更新Next按钮文本
                    updateNextButtonText();
                } else {
                    successMessage.style.display = 'none';
                    nextBtn.disabled = true;
                }
            } else {
                // 前3关：显示正确的单元格数
                correctCount.textContent = gameState.correctCells;
                incorrectCount.textContent = gameState.incorrectCells;
                
                // 更新移动端计分栏
                if (mobileCorrectCount) mobileCorrectCount.textContent = gameState.correctCells;
                if (mobileIncorrectCount) mobileIncorrectCount.textContent = gameState.incorrectCells;
                
                // 检查是否完成：所有单元格都正确
                if (gameState.filledCells === gameState.totalCells && gameState.correctCells === gameState.totalCells) {
                    gameState.isCompleted = true;
                    successMessage.style.display = 'block';
                    nextBtn.disabled = false;
                } else {
                    successMessage.style.display = 'none';
                    nextBtn.disabled = true;
                }
            }
        }

        // 检查第四关的行是否正确
        function checkRowForLevel4(rowIndex) {
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            const cells = row.querySelectorAll('.drop-zone');
            
            // 检查行是否已填满
            let isRowFilled = true;
            cells.forEach(cell => {
                if (cell.getAttribute('data-filled') !== 'true') {
                    isRowFilled = false;
                }
            });
            
            if (!isRowFilled) {
                // 行未填满，移除正确样式
                row.classList.remove('row-correct');
                return false;
            }
            
            // 收集行中所有卡片的数据
            const rowData = {
                fractions: [],
                decimals: [],
                percents: []
            };
            
            let isValid = true;
            cells.forEach(cell => {
                const card = cell.querySelector('.answer-card');
                if (card) {
                    const fraction = card.getAttribute('data-fraction');
                    const decimal = card.getAttribute('data-decimal');
                    const percent = card.getAttribute('data-percent');
                    
                    rowData.fractions.push(fraction);
                    rowData.decimals.push(decimal);
                    rowData.percents.push(percent);
                } else {
                    isValid = false;
                }
            });
            
            if (!isValid) return false;
            
            // 检查所有分数是否相同，所有小数是否相同，所有百分数是否相同
            const allFractionsSame = rowData.fractions.every(val => val === rowData.fractions[0]);
            const allDecimalsSame = rowData.decimals.every(val => val === rowData.decimals[0]);
            const allPercentsSame = rowData.percents.every(val => val === rowData.percents[0]);
            
            const isRowCorrect = allFractionsSame && allDecimalsSame && allPercentsSame;
            
            // 更新行样式
            if (isRowCorrect) {
                row.classList.add('row-correct');
            } else {
                row.classList.remove('row-correct');
            }
            
            return isRowCorrect;
        }

        // 检查所有行（用于第四关）
        function checkAllRowsForLevel4() {
            let correctRows = 0;
            for (let i = 0; i < gameState.totalRows; i++) {
                if (checkRowForLevel4(i)) {
                    correctRows++;
                }
            }
            gameState.correctRows = correctRows;
        }

        // Setup event listeners for drag and drop
        function setupEventListeners() {
            // 答案栏也添加拖放事件（PC端）
            answersContainer.addEventListener('dragover', handleDragOver);
            answersContainer.addEventListener('dragleave', handleDragLeave);
            answersContainer.addEventListener('drop', handleDrop);
            
            // Button events
            resetBtn.addEventListener('click', resetRound);
            nextBtn.addEventListener('click', nextRound);
            
            // Level selector events
            levelSelector.addEventListener('click', handleLevelSelect);
        }

        // Handle level selection
        function handleLevelSelect(e) {
            if (e.target.classList.contains('level-btn')) {
                const level = parseInt(e.target.getAttribute('data-level'));
                
                // 检查是否是当前关卡
                if (level === gameState.currentLevel) return;
                
                // 更新当前关卡
                gameState.currentLevel = level;
                gameState.currentRound = 1; // 重置为第一回合
                
                // 重新初始化游戏
                initGame();
            }
        }

        // ====== 事件处理函数 ======
        
        // Pointer Events 处理（移动端）- 修复版
        function handlePointerStart(e) {
            // 防止多点触摸
            if (e.pointerType === 'touch' && e.isPrimary === false) return;
            
            // 防止右键点击
            if (e.pointerType === 'mouse' && e.button !== 0) return;
            
            // 关键修复：始终阻止默认行为，防止页面滚动
            e.preventDefault();
            e.stopPropagation();
            
            // 开始拖拽
            const started = dragManager.startDrag(e.target, e.clientX, e.clientY);
            
            if (started) {
                // 设置捕获指针，确保移动事件被正确捕获
                e.target.setPointerCapture(e.pointerId);
            }
            
            // 阻止事件冒泡到父元素
            return false;
        }

        // 原有的PC端拖拽事件（保持兼容性）
        function handleDragStart(e) {
            // 如果答案已使用，不允许拖拽
            const cardId = e.target.id;
            if (gameState.cardLocations[cardId] !== 'bank') {
                e.preventDefault();
                return;
            }
            
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.id);
            
            // 修复拖拽闪现问题：始终阻止默认拖拽行为
            e.preventDefault();
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            
            // 添加高亮效果
            if (e.target.classList.contains('drop-zone') || e.target === answersContainer) {
                e.target.classList.add('over');
            }
        }
        
        function handleDragLeave(e) {
            if (e.target.classList.contains('drop-zone') || e.target === answersContainer) {
                e.target.classList.remove('over');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            
            // 移除高亮效果
            if (e.target.classList.contains('drop-zone') || e.target === answersContainer) {
                e.target.classList.remove('over');
            }
            
            // Get the dragged card
            const cardId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.getElementById(cardId);
            
            if (!draggedCard) return;
            
            // Determine drop target
            if (e.target === answersContainer || e.target.closest('#answersContainer') === answersContainer) {
                // Dropping back to answer bank
                returnToAnswerBank(draggedCard);
            } else if (e.target.classList.contains('drop-zone')) {
                // Dropping to a table cell
                dropToTableCell(draggedCard, e.target);
            } else if (e.target.closest('.drop-zone')) {
                // Dropping to a card inside a cell
                const cell = e.target.closest('.drop-zone');
                dropToTableCell(draggedCard, cell);
            }
        }

        // Return a card to the answer bank
        function returnToAnswerBank(card) {
            const cardId = card.id;
            
            // If card is already in the bank, do nothing
            if (gameState.cardLocations[cardId] === 'bank') return;
            
            // Remove card from its current cell
            const location = gameState.cardLocations[cardId];
            if (location && location !== 'bank') {
                const cell = document.querySelector(`.drop-zone[data-row-index="${location.row}"][data-type="${location.type}"]`);
                if (cell) {
                    // Remove the card from the cell
                    cell.innerHTML = '';
                    cell.setAttribute('data-filled', 'false');
                    cell.classList.remove('correct', 'incorrect');
                    
                    // Update counts
                    gameState.filledCells--;
                    
                    // 对于第四关，更新行检查
                    if (gameState.currentLevel === 4) {
                        checkAllRowsForLevel4();
                    } else {
                        // 前3关：检查这个单元格是否正确
                        if (cell.classList.contains('correct')) {
                            gameState.correctCells--;
                        } else if (cell.classList.contains('incorrect')) {
                            gameState.incorrectCells--;
                        }
                    }
                    
                    // Clear any validation classes
                    cell.classList.remove('correct', 'incorrect');
                }
            }
            
            // Reset card appearance
            card.classList.remove('in-cell');
            card.classList.add('in-bank');
            
            // 重新添加事件监听器（因为cloneNode不会复制事件监听器）
            card.addEventListener('pointerdown', handlePointerStart);
            card.setAttribute('draggable', 'true');
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            
            // Move card back to answer bank
            answersContainer.appendChild(card);
            
            // Update card location tracking
            gameState.cardLocations[cardId] = 'bank';
            
            // Update counts
            updateCounts();
            
            // 重新缓存拖放区域
            dragManager.cacheDropZones();
        }

        // Drop a card to a table cell
        function dropToTableCell(card, cell) {
            const cardId = card.id;
            const cardType = card.getAttribute('data-type');
            const cardValue = card.getAttribute('data-value');
            const cellType = cell.getAttribute('data-type');
            const rowIndex = cell.getAttribute('data-row-index');
            
            // Check if the cell already has a card
            const existingCard = cell.querySelector('.answer-card');
            if (existingCard) {
                // Swap cards: return existing card to bank and place new card
                returnToAnswerBank(existingCard);
            }
            
            // 对于第四关，不限制卡片类型，因为所有单元格都是空的
            // 对于前3关，检查卡片类型是否匹配单元格类型
            if (gameState.currentLevel !== 4 && cardType !== cellType) {
                // Show gentle visual feedback for incorrect type
                cell.classList.add('incorrect');
                setTimeout(() => {
                    cell.classList.remove('incorrect');
                }, 500);
                return;
            }
            
            // Get the row data for validation
            const row = cell.closest('tr');
            
            // 对于第四关，不需要预期值
            let expectedValue = null;
            if (gameState.currentLevel !== 4) {
                expectedValue = cell.getAttribute('data-expected');
            }
            
            // Remove card from its current location
            if (gameState.cardLocations[cardId] === 'bank') {
                // Card was in the bank
                card.remove();
            } else {
                // Card was in another cell
                const oldLocation = gameState.cardLocations[cardId];
                if (oldLocation && oldLocation !== 'bank') {
                    const oldCell = document.querySelector(`.drop-zone[data-row-index="${oldLocation.row}"][data-type="${oldLocation.type}"]`);
                    if (oldCell) {
                        oldCell.innerHTML = '';
                        oldCell.setAttribute('data-filled', 'false');
                        oldCell.classList.remove('correct', 'incorrect');
                        
                        // Update counts
                        gameState.filledCells--;
                        
                        // 对于第四关，更新行检查
                        if (gameState.currentLevel === 4) {
                            // 第四关的行检查会在之后统一进行
                        } else {
                            // 前3关：检查旧单元格是否正确
                            if (oldCell.classList.contains('correct')) {
                                gameState.correctCells--;
                            } else if (oldCell.classList.contains('incorrect')) {
                                gameState.incorrectCells--;
                            }
                        }
                    }
                }
            }
            
            // Create a new card for the cell (clone of the original)
            const newCard = card.cloneNode(true);
            newCard.classList.remove('in-bank');
            newCard.classList.add('in-cell');
            newCard.setAttribute('id', cardId); // 保持相同的ID
            
            // 添加事件监听器
            newCard.addEventListener('pointerdown', handlePointerStart);
            newCard.setAttribute('draggable', 'true');
            newCard.addEventListener('dragstart', handleDragStart);
            newCard.addEventListener('dragend', handleDragEnd);
            
            // Add card to cell
            cell.innerHTML = '';
            cell.appendChild(newCard);
            cell.setAttribute('data-filled', 'true');
            
            // 验证答案（根据关卡类型）
            let isCorrect = false;
            
            if (gameState.currentLevel === 4) {
                // 第四关：不验证单个单元格，而是验证整行
                // 单元格总是正确的（因为不验证类型）
                cell.classList.remove('correct', 'incorrect');
                isCorrect = true; // 单个单元格总是可以放置
            } else {
                // 前3关：验证单个单元格
                isCorrect = cardValue === expectedValue;
                
                // Apply appropriate styling
                cell.classList.remove('correct', 'incorrect');
                if (isCorrect) {
                    cell.classList.add('correct');
                    gameState.correctCells++;
                } else {
                    cell.classList.add('incorrect');
                    gameState.incorrectCells++;
                }
            }
            
            // Update counts
            gameState.filledCells++;
            
            // Update card location tracking
            gameState.cardLocations[cardId] = { row: rowIndex, type: cellType };
            
            // 对于第四关，检查整行
            if (gameState.currentLevel === 4) {
                checkRowForLevel4(rowIndex);
                checkAllRowsForLevel4();
            }
            
            // 重新缓存拖放区域
            dragManager.cacheDropZones();
            
            // Update counts and check completion
            updateCounts();
        }

        // Reset the current round
        function resetRound() {
            // Move all cards back to answer bank
            Object.keys(gameState.cardLocations).forEach(cardId => {
                if (gameState.cardLocations[cardId] !== 'bank') {
                    const card = document.getElementById(cardId);
                    if (card) {
                        returnToAnswerBank(card);
                    }
                }
            });
            
            // Reset counts
            gameState.filledCells = 0;
            gameState.correctCells = 0;
            gameState.correctRows = 0;
            gameState.incorrectCells = 0;
            
            // Clear all cells
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.innerHTML = '';
                zone.setAttribute('data-filled', 'false');
                zone.classList.remove('correct', 'incorrect', 'over');
            });
            
            // 清除第四关的行正确样式
            document.querySelectorAll('tr').forEach(row => {
                row.classList.remove('row-correct');
            });
            
            // Reset all cards in bank
            document.querySelectorAll('.answer-card').forEach(card => {
                card.classList.remove('in-cell');
                card.classList.add('in-bank');
                card.setAttribute('draggable', 'true');
            });
            
            // Reset UI
            successMessage.style.display = 'none';
            nextBtn.disabled = true;
            
            // 重新缓存拖放区域
            dragManager.cacheDropZones();
            
            // Update counts
            updateCounts();
        }

        // Move to next round or level
        function nextRound() {
            if (!gameState.isCompleted) return;
            
            // 特殊处理第四关
            if (gameState.currentLevel === 4 && gameState.currentRound === 2) {
                // 第四关第二回合完成：重新开始第四关的练习
                gameState.currentRound = 1;
                resetRound();
                initGame();
                return;
            }
            
            if (gameState.currentRound < gameState.totalRounds) {
                // Move to next round in the same level
                gameState.currentRound++;
                resetRound();
                initGame();
            } else {
                // Current level completed
                if (gameState.currentLevel < 4) {
                    // Move to next level
                    const nextLevel = gameState.currentLevel + 1;
                    const levelName = levelConfigs[nextLevel].description;
                    
                    alert(`Level ${gameState.currentLevel} completed! You have successfully matched all values. Moving to Level ${nextLevel}: ${levelName}.`);
                    
                    gameState.currentLevel = nextLevel;
                    gameState.currentRound = 1;
                    resetRound();
                    initGame();
                } else {
                    // 第四关第一回合完成，进入第二回合
                    gameState.currentRound = 2;
                    resetRound();
                    initGame();
                }
            }
        }

        // Utility function to shuffle array
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 添加抖动动画关键帧（用于错误反馈）
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes shake {
                0%, 100% { transform: translate3d(0, 0, 0); }
                10%, 30%, 50%, 70%, 90% { transform: translate3d(-2px, 0, 0); }
                20%, 40%, 60%, 80% { transform: translate3d(2px, 0, 0); }
            }
        `;
        document.head.appendChild(styleSheet);

        // 初始化游戏
        function initMemoryGame() {
            // 初始化拖拽管理器
            dragManager.init();
            
            // 初始化游戏
            initGame();
        }

        // 页面加载时初始化所有功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化问答栏
            initPoll();
            
            // 初始化游戏
            initMemoryGame();
        });
    </script>
</body>
</html>